<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Member Admin</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="//ajax.aspnetcdn.com/ajax/jquery.mobile/1.0/jquery.mobile-1.0.min.css" />
    <link rel="stylesheet" href="/css/styles.css">
    <script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-1.6.4.min.js"></script>
    <script>
      window.jQuery || document.write('<script src="/js/libs/jquery-1.6.4.min.js"><\/script>')
    </script>
    <script src="//ajax.aspnetcdn.com/ajax/jquery.mobile/1.0/jquery.mobile-1.0.min.js"></script>
    <script>
      window.jQuery.mobile || document.write('<script src="/js/libs/jquery.mobile-1.0.min.js"><\/script>')
    </script>
    <script src="/js/rmodule.js"></script>
  </head>
  <body>
    <script src="/js/admin.js"></script>
<script>
var RMODULE = (function (my, $) {
  'use strict';

  var
    buildItemPage,
    buildNewItemPage,
    roleOptions,
    STATUSES,
    validateMember;


  STATUSES = {
    active : {
      id : 'active',
      name : 'Active'
    },
    pending : {
      id : 'pending',
      name : 'Pending',
    }
  };

  my.getItemName = function () {
    return 'appMembers';
  };

  my.getItemLinkText = function (member) {
    var display, role;

    display = member.emailAddress;
    switch (member.role) {
    case my.ROLES.owner.id:
      display += ' $$';
      break;
    case my.ROLES.manager.id:
      display += ' *';
      break;
    }
    switch (member.status) {
    case STATUSES.pending.id:
      display += ' (' + STATUSES.pending.name + ')';
      break;
    }
    return display;
  };

  roleOptions = function() {
    var i, markup, roles;

    roles = [{
      id : my.ROLES.owner.id,
      name : my.ROLES.owner.name
    }, {
      id : my.ROLES.manager.id,
      name : my.ROLES.manager.name
    }, {
      id : my.ROLES.member.id,
      name : my.ROLES.member.name
    }];
    return my.getOptionsForSelect(roles, 'Roles');
  }

  my.itemPage = function (page, url) {
    var id, restUrl;

    page.find('form')[0].reset();
    id = my.getParameterByName(url.hash, 'item_id');
    $('#role').html(roleOptions()).selectmenu();
    if (id === my.getNewItemName()) {
      buildNewItemPage(page);
    } else {
      restUrl = my.getRestPrefix() + my.getItemPath() + '\/' + id;
      my.jsonPopulate(restUrl, page, buildItemPage);
    }
  };

  buildItemPage = function (page, member) {
    my.pageHeader(page).find('h1').html('Update Member');
    $('#item_id').val(member.id);
    $('#emailAddress').val(member.emailAddress);
    $('#role').val(member.role).selectmenu('refresh');
    $('#delete_item_button').show();
  };

  buildNewItemPage = function (page) {
    my.pageHeader(page).find('h1').html('New Member');
    $('#item_id').val(my.getNewItemName());
    $('#role').val(my.getNoOptionSelected()).selectmenu('refresh');
    $('#delete_item_button').hide();
  };

  // This form handling function is set up in the admin.js#my.init function
  my.saveItem = function () {
    var id, json, restUrl;

    if (!validateMember()) {
      return false;
    }

    restUrl = my.getRestPrefix() + my.getItemPath();
    json = JSON.stringify({
      emailAddress: $('#emailAddress').val(),
      role: $('#role').val(),
    });

    id = $('#item_id').val();
    if (id === my.getNewItemName()) {
      my.postJson(restUrl, json, function () {
        history.back();
      });
    } else {
      restUrl += '\/' + id;
      my.putJson(restUrl, json, function () {
        history.back();
      });
    } 
    return false;
  };

  validateMember = function () {
    if (!my.validEmailAddress($('#emailAddress').val())) {
      window.alert('Please enter a valid email address.');
      return false;
    }
    if ($('#role').val() === my.getNoOptionSelected()) {
      window.alert('Please select a role.');
      return false;
    }
    return true;
  }

  return my;
}(RMODULE, jQuery));

RMODULE.init();
</script>

<div data-role="page" id="index" data-title="Member Admin">
  <div data-role="header">
    <a href="#" data-rel="back">Back</a>
    <h1>All Members</h1>
  </div>
  <div data-role="content"></div>
  <div data-role="footer">
    <div data-role="navbar">
      <ul>
        <li><a href="" id="new_item_button">Create New Member</a></li>
      </ul>
    </div>
  </div>
</div>


<div data-role="page" id="item" data-title="Member">
  <div data-role="header">
    <a href="#" data-rel="back">Back</a>
    <h1></h1>
  </div>
  <div data-role="content">
    <form>
      <input type="hidden" name="item_id" id="item_id">

      <label for="emailAddress" class="ui-hidden-accessible">Email Address:</label>
      <input type="email" name="emailAddress" id="emailAddress" placeholder="Email Address" required>

      <label for="role" class="ui-hidden-accessible">Role:</label>
      <select name="role" id="role"></select>

      <input type="submit" value="Save">
      <p>
        <a id="delete_item_button" href="#delete" data-role="button" data-theme="e">Delete Member</a>
      </p>
    </form>
  </div>
  <div data-role="footer">
    <div data-role="navbar">
      <ul>
        <li><a href="#index">Cancel</a></li>
      </ul>
    </div>
  </div>
</div>

<div data-role="dialog" id="delete">
  <div data-role="header">
    <h1>Delete</h1>
  </div>
  <div data-role="content">
    <div style="text-align: center;">
      <h1>Delete Member</h1>
      <p>Are you sure?</p>
    </div>
    <p>
      <a id="delete_item" data-role="button">Delete Member</a>
    </p>
    <p>
      <a href="" data-role="button" data-rel="back">Cancel</a>
    </p>
  </div>
</div>

  </body>
</html>
