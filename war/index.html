<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <script> if (location.hostname === "www.rskybox.com") { location.href = "https://rskybox-stretchcom.appspot.com"; } </script>
    <title>rSkybox</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="//ajax.aspnetcdn.com/ajax/jquery.mobile/1.0/jquery.mobile-1.0.min.css" />
    <link rel="stylesheet" href="/css/styles.css">
    <script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-1.6.4.min.js"></script>
    <script>
      jQuery || document.write('<script src="\/js\/libs\/jquery-1.6.4.min.js"><\/script\>')
    </script>
    <script src="//ajax.aspnetcdn.com/ajax/jquery.mobile/1.0/jquery.mobile-1.0.min.js"></script>
    <script>
      jQuery.mobile || document.write('<script src="\/js\/libs\/jquery.mobile-1.0.min.js"\><\/script\>')
    </script>
    <script src="/js/libs/cookie.js"></script>
    <script src="/js/rmodule.js"></script>
  </head>
  <body>
    <script src="/js/forms.js"></script>
<script src="/js/signup.js"></script>
<script>
'use strict';

var RMODULE = (function (my, $) {

  var
    confirmMember,
    confirmPage,
    confirmUser,
    createUser,
    getConfirmObject,
    login,
    loginFail,
    loginSuccess,
    requestConfirmCode;


  // Called when submit is performed on the signup form.
  requestConfirmCode = function () {
    var json, signup;

    signup = {};
    my.addFormProperty(signup, 'emailAddress', $('#emailAddress').val());
    my.addFormProperty(signup, 'phoneNumber', $('#phoneNumber').val());
    my.addFormProperty(signup, 'mobileCarrierId', $('#mobileCarrierId').val());

    if (!my.isValidSignup(signup)) {
      alert('Please enter your email address, or your phone number and mobile carrier.');
      return false;
    }

    json = JSON.stringify(signup);
    my.postJson(my.getRestPrefix() + '\/users\/requestConfirmation', json, function (data) {
      $.mobile.changePage('#confirm' + my.getQueryString(signup));
    });
    return false;
  }


  // Called on successful return from requestConfirmation and from email links with confirmation codes.
  confirmPage = function (page, url) {
    var confirmationCode, email, phone;

    email = my.getParameterByName(url.hash, 'emailAddress');
    phone = my.getParameterByName(url.hash, 'phoneNumber');
    confirmationCode = my.getParameterByName(url.hash, 'confirmationCode');

    email && $('#emailDisplay').html(email);
    phone && $('#phoneDisplay').html(phone);
    $('#confirmEmail').val(email);
    $('#confirmPhone').val(phone);
    $('#confirmationCode').val(confirmationCode);
    $('#emailWrapper').toggle(!!email);
    $('#phoneWrapper').toggle(!!phone);
    if (my.getParameterByName(url.hash, 'preregistration') === 'false') {
      $('#confirmPasswordWrapper').hide();
    }
  };


  getConfirmObject = function () {
    var confirmation = {};

    my.addFormProperty(confirmation, 'confirmationCode', $('#confirmationCode').val());
    my.addFormProperty(confirmation, 'password', $('#confirmPassword').val());
    my.addFormProperty(confirmation, 'emailAddress', $('#confirmEmail').val());
    my.addFormProperty(confirmation, 'phoneNumber', $('#confirmPhone').val());

    return confirmation;
  };


  // Called from confirm page to create the user.
  createUser = function () {
    var confirmation = getConfirmObject();

    if (!my.isValidConfirmationCode(confirmation.confirmationCode)) {
      alert('Please enter your confirmation code.');
    } else if (!my.isValidPassword(confirmation.password)) {
      alert('Please enter a valid password.');
    } else {
      my.postJson(my.getRestPrefix() + '\/users', JSON.stringify(confirmation), function (user) {
        loginSuccess(user.token);
      });
    }
    return false;
  };


  // Called from confirm page to confirm user email address or phone number.
  confirmUser = function () {
    var confirmation = getConfirmObject();

    if (!my.isValidConfirmationCode(confirmation.confirmationCode)) {
      alert('Please enter your confirmation code.')
    } else {
      my.putJson(my.getRestPrefix() + '\/users\/confirm', JSON.stringify(confirmation), function (user) {
        my.redirect('\/');
      });
    }
    return false;
  };


  // Called from confirm page to confirm member email address.
  confirmMember = function () {
    var confirmation, restUrl;

    confirmation = getConfirmObject();

    if (!my.isValidConfirmationCode(confirmation.confirmationCode)) {
      alert('Please enter your confirmation code.')
    } else {
      restUrl  = my.getRestPrefix();
      restUrl += '\/applications\/' + my.getParameterByName(location.hash, 'applicationId');
      restUrl += '\/appMembers\/confirmation';
      my.putJson(restUrl, JSON.stringify(confirmation), function (user) {
        switch (+user.apiStatus) {
        // same action for both 100 and 214
        case 100:  // success
        case 214:  // member not pending confirmation
          my.redirect('\/');
          break;
          // same action for both 100 and 214
        case 215:  // member not a registered user
          $('#confirmSignup').show();
          break;
        case 606: // app member not found
          // TODO - rskybox logging
          console.log('Your app membership cannot be confirmed.');
          break
        default:
          // TODO - rskybox logging
          console.log('this shouldn\'t happen');
        }
      });
    }
  };


  // Called when the login form is submitted.
  login = function () {
    var login, json;

    login = {};
    my.addFormProperty(login, 'password', $('#loginPassword').val());
    my.addFormProperty(login, 'emailAddress', $('#loginEmail').val());
    my.addFormProperty(login, 'phoneNumber', $('#loginPhone').val());
    if (my.isValidLogin(login)) {
      login.userName = !!login.emailAddress ? login.emailAddress :loginPhoneNumber;
      delete login.emailAddress;
      delete login.phoneNumber;
      $.getJSON(my.getRestPrefix() + '\/users\/token', login, function (result) {
        if (result.apiStatus == "100") {
          loginSuccess(result.token); } else {
          loginFail(result);
        }
      });
    } else {
      alert('Please supply valid login information.');
    }

    return false;
  };


  loginFail = function (result) {
    // TODO show appropriate status messages on login fail
    console.log('TODO show appropriate status messages on login fail');
  };


  loginSuccess = function (token) {
    Cookie.set('token', token, 9000, '\/');
    my.redirect('\/html5');
  };


  my.init = function () {
    $('#index').live('pagebeforecreate', function () {
      // If there is a current user, redirect right away.
      if (Cookie.get('token')) {
        my.getCurrentUser(function () {
          my.redirect('\/html5');
        });
      }
    });

    $('#index').live('pageshow', function () {
      my.jsonPopulate(my.getMobileCarriersUrl(), $('#mobileCarrierId'), function (select, carriers) {
        select.html(my.getOptionsForSelect(carriers.mobileCarriers, 'Mobile Carriers')).selectmenu('refresh');
      });
    });

    $('#index').live('pagecreate', function () {
      $(this).find('form').submit(requestConfirmCode);
    });


    $('#confirm').live('pagecreate', function () {
      var email, phone, prereg, submit;

      if (my.getParameterByName(location.hash, 'memberConfirmation')) {
        confirmMember();
      } else {
        prereg = my.getParameterByName(location.hash, 'preregistration');
        // If this is a new user...
        if (!prereg || prereg === 'true') {
          submit = createUser;
        } else if (prereg === 'false') {
          submit = confirmUser;
        }
      }
      if (submit) {
        $(this).find('form').submit(submit);
      }
    });

    $('#login').live('pagecreate', function () {
      $(this).find('form').submit(login);
    });

    my.dynamicPages([{
      page: '#confirm',
      function: confirmPage
    }]);
  };

  return my;
}(RMODULE || {}, jQuery));

RMODULE.init();
</script>

<div data-role="page" id="index" data-title="rSkybox Signup">
  <div data-role="header">
    <h1>rSkybox Signup</h1>
    <a href="#login" class="ui-btn-right">Log In</a>
  </div>
  <div data-role="content">
    <div style="text-align: center;">
      <strong>Watch your application from the best seat in the house.</strong>
    </div>
    <form>
      <h1>Sign Up Using</h1>
      <label for="emailAddress" class="ui-hidden-accessible">Email Address:</label>
      <input type="email" name="emailAddress" id="emailAddress" placeholder="Email Address">
      <strong>or</strong>
      <label for="phoneNumber" class="ui-hidden-accessible">Phone Number:</label>
      <input type="tel" name="phoneNumber" id="phoneNumber" placeholder="Phone Number">
      <label for="mobileCarrierId" class="ui-hidden-accessible">Mobile Carrier:</label>
      <select name="mobileCarrierId" id="mobileCarrierId"></select>

      <input type="submit" value="Request Confirmation Code">
    </form>
  </div>
</div>

<div data-role="page" id="confirm" data-title="New User Signup">
  <div data-role="header">
    <h1>New User Signup</h1>
  </div>
  <div data-role="content">
    <div id="confirmSignup">
      <h3>Please create a password to complete your signup.</h3>
    </div>
    <form>
      <p id="emailWrapper" style="display: none;">
        <strong>Email Address: </strong><span id="emailDisplay"></span>
        <input type="hidden" id="confirmEmail">
      </p>
      <p id="phoneWrapper" style="display: none;">
        <strong>Phone Number: </strong><span id="phoneDisplay"></span>
        <input type="hidden" id="confirmPhone">
      </p>

      <strong>Please enter your confirmation code.</strong>
      <label for="confirmationCode" class="ui-hidden-accessible">Confirmation Code:</label>
      <input type="tel" name="confirmationCode" id="confirmationCode" placeholder="Confirmation Code">

      <div id="confirmPasswordWrapper">
        <strong>Create a password. (min 6 chars)</strong>
        <label for="confirmPassword" class="ui-hidden-accessible">Password:</label>
        <input name="confirmPassword" id="confirmPassword" placeholder="Password">
      </div>

      <input type="submit" value="Complete Sign Up">
    </form>
  </div>
</div>

<div data-role="page" id="login" data-title="Login">
  <div data-role="header">
    <h1>Login</h1>
  </div>
  <div data-role="content">
    <form>
      <h1>Login Using</h1>
      <label for="loginEmail" class="ui-hidden-accessible">Login Email Address:</label>
      <input type="email" name="loginEmail" id="loginEmail" placeholder="Login Email Address">
      <strong>or</strong>
      <label for="loginPhone" class="ui-hidden-accessible">Login Phone Number:</label>
      <input type="tel" name="loginPhone" id="loginPhone" placeholder="Login Phone Number">

      <hr>

      <label for="loginPassword" class="ui-hidden-accessible">Login Password:</label>
      <input type="password" name="loginPassword" id="loginPassword" placeholder="Login Password">

      <input type="submit" value="Login">
    </form>
  </div>
</div>

  </body>
</html>
